<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>大阪万博 現在地マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet/dist/leaflet.css" 
  />
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // 画像サイズ（px）
    const imageWidth = 3987;
    const imageHeight = 2805;

    // 緯度経度と画像上ピクセル座標の対応点（西ゲート、東ゲート、静けさの森）
    const geoPoints = [
      { lat: 34.650710020554186, lng: 135.38024218610832, x: 1044.0, y: 1078.6 }, // 西ゲート
      { lat: 34.650001585421606, lng: 135.38766044444782, x: 3394.3, y: 1265.2 }, // 東ゲート
      { lat: 34.64995962259391, lng: 135.38360963067086, x: 2140.8, y: 1276.8 }   // 静けさの森
    ];

    // Leafletマップ作成（ピクセルベース）
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomSnap: 0.1
    });

    // 画像範囲（左上が(0,0)、右下が(imageHeight, imageWidth)）
    const bounds = [[0, 0], [imageHeight, imageWidth]];

    // 地図画像の読み込み
    L.imageOverlay('BanpakuMap.jpg', bounds).addTo(map);
    map.fitBounds(bounds);

    // アフィン変換の計算
    function latLngToImageXY(lat, lng) {
      // 緯度経度の差分とピクセル差分
      const [p1, p2, p3] = geoPoints;

      // 緯度経度ベクトル（地理座標 → 数値）
      const ax = p1.lng, ay = p1.lat;
      const bx = p2.lng, by = p2.lat;
      const cx = p3.lng, cy = p3.lat;

      // ピクセル座標
      const u1 = p1.x, v1 = p1.y;
      const u2 = p2.x, v2 = p2.y;
      const u3 = p3.x, v3 = p3.y;

      // 緯度経度 → 画像xy変換のための線形変換（アフィン変換）
      // 求めたいのは x = a*lng + b*lat + c, y = d*lng + e*lat + f の係数
      const A = [
        [ax, ay, 1],
        [bx, by, 1],
        [cx, cy, 1]
      ];
      const U = [u1, u2, u3];
      const V = [v1, v2, v3];

      function solveAffine(A, B) {
        const m = math.inv(A);
        return math.multiply(m, B);
      }

      // math.jsでアフィン変換行列を解く
      const aCoeffs = solveAffine(A, U);
      const bCoeffs = solveAffine(A, V);

      // 目的の緯度経度をピクセルに変換
      const x = aCoeffs[0] * lng + aCoeffs[1] * lat + aCoeffs[2];
      const y = bCoeffs[0] * lng + bCoeffs[1] * lat + bCoeffs[2];
      return [y, x]; // Leafletの形式に合わせて[y, x]
    }

    // math.js読み込み後に処理開始
    function plotCurrentLocation(lat, lng) {
      const [y, x] = latLngToImageXY(lat, lng);
      L.marker([y, x]).addTo(map).bindPopup("現在地").openPopup();
    }

    // 現在地の緯度経度（例：静けさの森の少し左）
    const currentLat = 34.6501;
    const currentLng = 135.3820;

    // math.jsを読み込んでからマーカーを表示
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjs@11.11.0/lib/browser/math.min.js';
    script.onload = () => {
      plotCurrentLocation(currentLat, currentLng);
    };
    document.head.appendChild(script);
  </script>

</body>
</html>
